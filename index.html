<!DOCTYPE html>
<html>
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">
    <title>Pixelate!</title>
    <style>
        canvas {
            width: 400px;
        }

        .colorSquare {
            position:static !important;
            display: inline-block !important;
            width: 20px;
            height: 20px;
            margin: 5px;
            cursor: pointer;
        }
        #modal * {
            position:absolute;
            z-index: 2;

        }
        #modal {
             animation: modal 14s ease-in-out infinite;
        }

        body {
            width:100%;
            overflow: hidden;
            background-color: #080414;
            background-image: url("bkg.gif");
            background-size: cover;
        }

        .title{
            image-rendering: pixelated;
            width:50%;

            animation: MoveUpDown 8s ease-in-out infinite !important;
            position: absolute;
            left: 0;
            bottom: 0;
        }

        @keyframes MoveUpDown {
            0%, 100% {
                transform: TranslateY(0);
            }

            50% {
                transform: TranslateY(-50px);
          }
        }

        @keyframes modal {
            0%, 100% {
                transform: TranslateY(0);
            }

            50% {
                transform: TranslateY(-25px);
          }
        }


        .in{
            animation: transition .25s ease-in-out forwards;
        }
        .out{
            animation: transitionOut .25s ease-in-out forwards;
        }
        .outspec *{
            animation: transitionOut .25s ease-in-out forwards;
        }
        .inspec *{
            animation: transition .25s ease-in-out forwards;
        }
        .dark{
            animation: darkenanim .25s ease-in-out forwards;
        }
        .light{
           animation: lighten .25s ease-in-out forwards; 
        }

        @keyframes darkenanim {
            0% {opacity: 0%;}
            100% {opacity:60%}
        }
        @keyframes lighten {
            0% {opacity: 60%}
            100% {opacity:0%;}
        }
        @keyframes transition {
            0% {opacity: 0%;}
            100% {opacity:100%}
        }
        @keyframes transitionOut {
            0% {opacity: 100%}
            100% {opacity:0%;}
        }




        .leftc{
           animation: leftt .5s ease-in-out forwards !important; 
        }


        @keyframes leftt {
            0% {transform: TranslateX(0%);}
            100% {transform: TranslateX(-100%);}
        }

        .rightc{
           animation: rightt .5s ease-in-out forwards !important; 
        }


        @keyframes rightt {
            0% {transform: TranslateX(-100%);}
            100% {transform: TranslateX(0%);}
        }


        .upload-image{
            image-rendering: pixelated;
            width:20%;

            animation: MoveUpDown 8s ease-in-out infinite;
            animation-delay: 1000ms;
            position: absolute;
            left: 0;
            bottom: 0;
        }

        .upload-image:hover{
            cursor:pointer;
        }

         .cloud{
            pointer-events: none;
            image-rendering: pixelated;
            width:7%;

            animation: MoveUpDown 8s ease-in-out infinite;
            animation-delay: 1250ms;
            position: absolute;
            left: 5.5%;
            bottom: 55px;
        }

        #menu{
            width:100%;
            height:100%;
            position:absolute;
            top:-15%;
            left:27%;
        }

        .modalbkg{
            width:70%;
            position:absolute;
            left:15%;
            z-index:1 !important;
        }

        .holder {
            width: 28.85%;
            height:26vw;
            position:absolute;
            left:34%;
            overflow:hidden;
            top:12vw;
        }
        .holder * {
            display:inline-block;
        }

        .canvas {
            object-fit: contain;
            object-position: 50% 50%;
              max-width:100%;
              max-height:100%;
              display:block;
              position:absolute;
              left:0;
              right:0;
              bottom:0;
              top:0;
              margin:auto;
              /*i have no idea how this works, i hate css so much*/
            animation:none !important;

        }

        #darken{
            opacity:0;
            width:100%;
            min-height:100vh;
            background-color: black;
            z-index:-1;
            position:absolute;
        }

        #darken:hover{
            cursor:pointer;
        }

        .scaleinp{
            position:absolute;
            left:34%;
            top:42.5vw;
            animation:modal 14s ease-in-out infinite; !important;
        }
        .scaleinp *{
            width:100px;
        }

        .color{
            animation:modal 14s ease-in-out infinite; !important;
            position:absolute;
            width:5%;
            left:47.5%;
            top:42.5vw;
        }

        #compressButton{
            width:100px;
            animation:modal 14s ease-in-out infinite; !important;
            position:absolute;
            left:54%;
            top:42.5vw;
        }

        #colsdiv{
            width: 100%;
            min-height: 26vw;
            background-color: red;
            left:100%;
        }
        #canvases{
            width:100%;
            height:100%;
        }

        #addColorButton{
            left:200px;
        }

        #colorPicker{
            left:100px;
        }

        #saves {
            top:100px;
            background-color: grey;
            width:100px;
            min-height:50px;

        }
        #colorList {
            background-color: grey;
            height:75%;
            width:90%;
            left:5%;
            top:6vw;
            overflow-y:overlay;
            scrollbar
        }

        #colorList::-webkit-scrollbar {
            background: transparent;

        }
        #colorList::-webkit-scrollbar-thumb {
            background: black;
            border-radius:10px;

        }

        #colname {
            left:270px;
            top:0px;
        }

        #colprofile {
            background-color:grey;
            width: 28.85%;
            height:26vw;
            position:absolute;
            left:34.5%;
            overflow:hidden;
            top:12vw;
            animation:modal 14s ease-in-out infinite;
            animation-delay: .25s;
        }

        #palette {
            width:50%;
            height:12vw;
            left:25%;
            top:30%;
            background-color:red;
            position:absolute;
        }

        #rename{
            background-color: transparent;
            border:none;
            cursor: text;
            outline:none;
            color:white;
            width:90%;
            max-lines: 2;
            font-size:32px;
            resize:none;
            font-family: "Pixelify Sans";
        }

        #del {

        }

        #edit {

        }
        /*colorPicker
addColorButton
colorList*/
        

    </style>

</head>
<body> 

    <div id="darken" style="display:none;" onclick="closemodal()"></div>
    <div id="menu">
        <img src="title.png" class="title">

        <input style="display:none" type="file" id="imageInput" accept="image/*">

        <img src="upload.png" alt="Upload" onclick="document.getElementById('imageInput').click();" class="upload-image">

        <img src="cloud.png" class="cloud">
    </div>

    <div id="modal" style="display:none;">
        <img src="modal.png" class="modalbkg">
        <div class="holder">
            <div id="canvases">
                <canvas id="originalCanvas" class="canvas"></canvas>
                <canvas  id="compressedCanvas" class="canvas"></canvas>
            </div>
            <div id="colsdiv">
                <h1>colors</h1>
                <input type="color" id="colorPicker">
                <input type="text" id="colname" placeholder="name">
                <button id="addColorButton">Add</button>
                <button id="coltoggle" onclick="togglecols()">Use cols</button>
                <div id="colorList"></div>
            </div>      

            </div>
        <div  class="scaleinp">
            <input type="number" id="desiredWidth" placeholder="Desired Width" min="1" oninput="clearHeight()">
            <input type="number" id="desiredHeight" placeholder="Desired Height" min="1" oninput="clearWidth()">
        </div>
        <div class="color">
            <button id="colsmenu" onclick="opencolormenu()">+</button>
        </div>
        <button id="compressButton">Compress!</button>

    </div>



    <div id="colprofile" style="display:none;">
        <textarea maxlength="28" id="rename" type="text" placeholder="PLACEHOLDER"></textarea>

        <button id="del">delete</button>
        <input id="edit" class="palette" type="color">
    </div> 
    <script>

        let colors = JSON.parse(localStorage.getItem('saves'));
        if (null==colors){
            colors=[];
        }
        let names = JSON.parse(localStorage.getItem('names'));
        if (null==names){
            names=[];
        }

        let img = new Image();
        let originalCanvas = document.getElementById('originalCanvas');
        let originalCtx = originalCanvas.getContext('2d');
        let compressedCtx;
        let compressedCanvas;
        let modal = document.getElementById("modal");
        let menu = document.getElementById("menu");
        let darken = document.getElementById("darken");

        let colsmenu = document.getElementById("colsdiv");
        let canvy = document.getElementById("canvases");
        let colbtn = document.getElementById("colsmenu");

        let profile = document.getElementById("colprofile");


        let file;
        let reader;

        renderColorList();





        openModal();
        opencolormenu();


        document.getElementById('imageInput').addEventListener('change', handleImageUpload);
        document.getElementById('compressButton').addEventListener('click', pixelateImage);
        document.getElementById('addColorButton').addEventListener('click', addColor);


        function save(){
            localStorage.setItem('saves',JSON.stringify(colors));
            localStorage.setItem('names', JSON.stringify(names));
        }


        function handleImageUpload(event) {
            console.log("handlwe");
            file = event.target.files[0];
            reader = new FileReader();

            reader.onload = function(e) {
                img.onload = function() {
                    originalCanvas.width = img.width;
                    originalCanvas.height = img.height;
                    originalCtx.drawImage(img, 0, 0);
                };
                img.src = e.target.result;
            };

            reader.readAsDataURL(file);

            openModal();

            event.target.value="";
            
        }

        function opencolormenu(){
            console.log("opencols");
            colbtn.textContent="<";
            setTimeout(function(){
                colbtn.onclick=function(){closecolormenu();}
            }, 500);

            colsmenu.classList.remove("rightc");
            canvy.classList.remove("rightc");
            colsmenu.classList.add("leftc");
            canvy.classList.add("leftc");
        }


        function closecolormenu(){
            colbtn.textContent="+";
            setTimeout(function(){
                colbtn.onclick=function(){opencolormenu();}
            }, 500);
            colsmenu.classList.remove("leftc");
            canvy.classList.remove("leftc");
            colsmenu.classList.add("rightc");
            canvy.classList.add("rightc");
        }

        function openModal(){
            console.log("open");
            menu.classList.remove("inspec");
            menu.classList.add("outspec");
            setTimeout(function(){
                menu.style.display="none";
            }, 250);

            modal.classList.remove("outspec");
            modal.classList.add("inspec");

            modal.style.display="block";
            darken.style.display="block";

            darken.classList.remove("light");
            darken.classList.add("dark");
        }

        function closemodal(){

            closecolorprofile();
            closecolormenu();

            console.log("close");
            menu.style.display="block";
            menu.classList.remove("outspec");
            menu.classList.add("inspec");

            modal.classList.remove("inspec");
            modal.classList.add("outspec");

            darken.classList.remove("dark");
            darken.classList.add("light");
            setTimeout(function(){
                modal.style.display="none";
                darken.style.display="none";
            }, 250);

            compressedCtx.clearRect(0, 0, compressedCanvas.width, compressedCanvas.height);
            originalCtx.clearRect(0, 0, originalCanvas.width, originalCanvas.height);
            compressedCanvas.style.display="none";
        }

        function clearWidth() {
            document.getElementById('desiredWidth').value = '';
        }

        function clearHeight() {
            document.getElementById('desiredHeight').value = '';
        }

        function addColor() {
            const colorPicker = document.getElementById('colorPicker');
            let color = colorPicker.value;
            colors.push(color);

            const nametext = document.getElementById("colname");
            let name = nametext.value;
            names.push(name);
            nametext.value="";

            renderColorList();
            save();
        }

        function removeColor(index) {
            colors.splice(index, 1);
            names.splice(index, 1);

            renderColorList();
            save();
        }

        function renderColorList() {
            const colorList = document.getElementById('colorList');
            colorList.innerHTML = '';
            colors.forEach((color, index) => {
                let listItem = document.createElement('button');
                listItem.classList.add('colorSquare');
                listItem.style.backgroundColor = color;
                listItem.onclick = () => opencol(index);
                colorList.appendChild(listItem);
            });
        }

        function opencol(index){

            let rename = document.getElementById("rename");
            //let palette = document.getElementById("palette");
            let del = document.getElementById("del");
            let edit = document.getElementById("edit");

            rename.value=names[index];

            rename.onchange=function(){names[index]=rename.value};
            edit.value=colors[index];
            //edit.style.backgroundColor=colors[index];
            del.onclick=function(){removeColor(index);closecolorprofile();};
            edit.onchange=function(){colors[index]=edit.value;};






            opencolorprofile();


            //onchange="rename()"
            //delete
            //edit col
        }


        function opencolorprofile(){
            profile.style.display="block";
            colsmenu.classList.remove("leftc");
            colsmenu.style.transform="transformX('-100%')";
            colsmenu.classList.remove("inspec");
            colsmenu.classList.add("outspec");

            colbtn.onclick=function(){closecolorprofile();}

            profile.classList.remove("outspec");
            profile.classList.add("inspec");

        }

        function closecolorprofile(){
            colbtn.onclick=function(){closecolormenu();}
            setTimeout(function(){
                profile.style.display="none";
            }, 250);
            profile.classList.remove("inspec");
            profile.classList.add("outspec");


            colsmenu.classList.remove("outspec");
            colsmenu.classList.add("leftc");
            save();
            renderColorList();
        }

        function pixelateImage() {

            closecolormenu();
            closecolorprofile();


            const desiredWidth = parseInt(document.getElementById('desiredWidth').value);
            const desiredHeight = parseInt(document.getElementById('desiredHeight').value);

            if (isNaN(desiredWidth) && isNaN(desiredHeight)) {
                alert("Please enter a valid desired width or height greater than 0.");
                return;
            }

            let scaleFactor;
            if (!isNaN(desiredWidth)) {
                scaleFactor = img.width / desiredWidth;
            } else if (!isNaN(desiredHeight)) {
                scaleFactor = img.height / desiredHeight;
            }

            const newWidth = Math.floor(img.width / scaleFactor);
            const newHeight = Math.floor(img.height / scaleFactor);

            const imageData = originalCtx.getImageData(0, 0, img.width, img.height);
            const pixels = imageData.data;

            compressedCanvas = document.getElementById('compressedCanvas');
            compressedCtx = compressedCanvas.getContext('2d');
            compressedCanvas.width = img.width;
            compressedCanvas.height = img.height;

            for (let y = 0; y < newHeight; y++) {
                for (let x = 0; x < newWidth; x++) {
                    let r = 0, g = 0, b = 0, a = 0;
                    let count = 0;

                    for (let ky = 0; ky < scaleFactor; ky++) {
                        for (let kx = 0; kx < scaleFactor; kx++) {
                            const originalX = Math.floor(x * scaleFactor + kx);
                            const originalY = Math.floor(y * scaleFactor + ky);
                            if (originalX < img.width && originalY < img.height) {
                                const index = (originalY * img.width + originalX) * 4;
                                r += pixels[index];
                                g += pixels[index + 1];
                                b += pixels[index + 2];
                                a += pixels[index + 3];
                                count++;
                            }
                        }
                    }

                    r = r / count;
                    g = g / count;
                    b = b / count;
                    a = a / count;

                    // Find the closest color
                    if (colors.length==0){
                        compressedCtx.fillStyle = `rgba(${r},${g},${b},${a / 255})`;
                        compressedCtx.fillRect(x * scaleFactor, y * scaleFactor, Math.ceil(scaleFactor), Math.ceil(scaleFactor));
                    } else {
                        const closestColor = findClosestColor(r, g, b);
                        // Draw the closest color
                        compressedCtx.fillStyle = closestColor;
                        compressedCtx.fillRect(x * scaleFactor, y * scaleFactor, Math.ceil(scaleFactor), Math.ceil(scaleFactor));
                    }
                }
            }

        compressedCanvas.style.display="initial";
        instructionsInit();

        }

        function instructionsInit(){
            compressedCanvas;
            //darken and turn pointer then show onclick n stuff
        }

        function stopInstructions(){
            
        }

        function findClosestColor(r, g, b) {
            let minDistance = Infinity;
            let closestColor = '#FFFFFF'; // Default to white if no colors are selected

            colors.forEach(color => {
                const colorRgb = hexToRgb(color);
                const distance = Math.sqrt(Math.pow(r - colorRgb.r, 2) + Math.pow(g - colorRgb.g, 2) + Math.pow(b - colorRgb.b, 2));
                if (distance < minDistance) {
                    minDistance = distance;
                    closestColor = color;
                }
            });

            return closestColor;
        }

        function hexToRgb(hex) {
            // Remove leading # and convert to base 16
            hex = hex.replace(/^#/, '');
            const bigint = parseInt(hex, 16);

            // Extract RGB components
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;

            return { r, g, b };
        }
    </script>
</body>
</html>