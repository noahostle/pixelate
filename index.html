<!DOCTYPE html>
<html>
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">
    <title>Pixelate!</title>
    <style>
        canvas {
            width: 400px;
        }

        .colorSquare {
            position:static !important;
            display: inline-block !important;
            width: 40px;
            height: 40px;
            margin: 5px;
            cursor: pointer;
            border:white 1.5px solid;
            border-radius:25px;
        }
        #modal * {
            position:absolute;
            z-index: 2;

        }
        #modal {
             animation: modal 14s ease-in-out infinite;
        }

        body {
            width:100%;
            overflow: hidden;
            background-color: #080414;
            background-image: url("bkg.gif");
            background-size: cover;
        }

        .title{
            image-rendering: pixelated;
            width:50%;

            animation: MoveUpDown 8s ease-in-out infinite !important;
            position: absolute;
            left: 0;
            bottom: 0;
        }

        @keyframes MoveUpDown {
            0%, 100% {
                transform: TranslateY(0);
            }

            50% {
                transform: TranslateY(-50px);
          }
        }

        @keyframes modal {
            0%, 100% {
                transform: TranslateY(0);
            }

            50% {
                transform: TranslateY(-25px);
          }
        }


        .in{
            animation: transition .25s ease-in-out forwards;
        }
        .out{
            animation: transitionOut .25s ease-in-out forwards;
        }
        .outspec *{
            animation: transitionOut .25s ease-in-out forwards;
        }
        .inspec *{
            animation: transition .25s ease-in-out forwards;
        }
        .dark{
            animation: darkenanim .25s ease-in-out forwards;
        }
        .light{
           animation: lighten .25s ease-in-out forwards; 
        }

        @keyframes darkenanim {
            0% {opacity: 0%;}
            100% {opacity:60%}
        }
        @keyframes lighten {
            0% {opacity: 60%}
            100% {opacity:0%;}
        }
        @keyframes transition {
            0% {opacity: 0%;}
            100% {opacity:100%}
        }
        @keyframes transitionOut {
            0% {opacity: 100%}
            100% {opacity:0%;}
        }




        .leftc{
           animation: leftt .5s ease-in-out forwards !important; 
        }


        @keyframes leftt {
            0% {transform: TranslateX(0%);}
            100% {transform: TranslateX(-100%);}
        }

        .rightc{
           animation: rightt .5s ease-in-out forwards !important; 
        }


        @keyframes rightt {
            0% {transform: TranslateX(-100%);}
            100% {transform: TranslateX(0%);}
        }


        .upload-image{
            image-rendering: pixelated;
            width:20%;

            animation: MoveUpDown 8s ease-in-out infinite;
            animation-delay: 1000ms;
            position: absolute;
            left: 0;
            bottom: 0;
        }

        .upload-image:hover{
            cursor:pointer;
        }

         .cloud{
            pointer-events: none;
            image-rendering: pixelated;
            width:7%;

            animation: MoveUpDown 8s ease-in-out infinite;
            animation-delay: 1250ms;
            position: absolute;
            left: 5.5%;
            bottom: 55px;
        }

        #menu{
            width:100%;
            height:100%;
            position:absolute;
            top:-15%;
            left:27%;
        }

        .modalbkg{
            width:70%;
            position:absolute;
            left:15%;
            z-index:1 !important;
        }

        .holder {
            width: 28.85%;
            height:26vw;
            position:absolute;
            left:34%;
            overflow:hidden;
            top:12vw;
        }
        .holder * {
            display:inline-block;
        }

        .canvas {
            object-fit: contain;
            object-position: 50% 50%;
              max-width:100%;
              max-height:100%;
              display:block;
              position:absolute;
              left:0;
              right:0;
              bottom:0;
              top:0;
              margin:auto;
              /*i have no idea how this works, i hate css so much*/
            animation:none !important;

        }

        #darken{
            opacity:0;
            width:100%;
            min-height:100vh;
            background-color: black;
            z-index:-1;
            position:absolute;
        }

        #darken:hover{
            cursor:pointer;
        }

        .scaleinp{
            position:absolute;
            left:34%;
            top:42.5vw;
            animation:modal 14s ease-in-out infinite; !important;
        }
        .scaleinp *{
            width:100px;
        }

        .color{
            animation:modal 14s ease-in-out infinite; !important;
            position:absolute;
            width:5%;
            left:47.5%;
            top:42.5vw;
        }

        #compressButton{
            width:100px;
            animation:modal 14s ease-in-out infinite; !important;
            position:absolute;
            left:54%;
            top:42.5vw;
        }

        #colsdiv{
            width: 100%;
            min-height: 26vw;
            left:100%;
        }
        #canvases{
            width:100%;
            height:100%;
        }

        #addColorButton{
            left:200px;
        }

        #colorPicker{
            left:100px;
        }

        #saves {
            top:100px;
            background-color: grey;
            width:100px;
            min-height:50px;

        }
        #colorList {
            height:60%;
            width:90%;
            left:7%;
            top:8.5vw;
            overflow-y:overlay;
            
        }

        #colorList::-webkit-scrollbar {
            background: transparent;
            width:10px;

        }
        #colorList::-webkit-scrollbar-thumb {
            width:5px;
            background: white;
            border-radius:10px;

        }

        #colname {
            left:270px;
            top:0px;
        }

        #colprofile {
            width: 28.85%;
            height:26vw;
            position:absolute;
            left:34.5%;
            overflow:hidden;
            top:12vw;
            animation:modal 14s ease-in-out infinite;
            animation-delay: .25s;
        }

        #palette {
            width:50%;
            height:12vw;
            left:25%;
            top:30%;
            background-color:red;
            position:absolute;
        }

        #rename{
            background-color: transparent;
            border:none;
            cursor: text;
            outline:none;
            color:white;
            width:90%;
            max-lines: 2;
            font-size:32px;
            resize:none;
            font-family: "Pixelify Sans";
        }

        #del {
            position: absolute;
            width:10%;
            left:82.5%;
            top:80%;
            cursor:pointer;

        }

        #edit {
            width:50%;
            top:30%;
            position:absolute;
            left:25%;
            height:14vw;
           cursor: pointer;
        }

        /*toggle*/
                        .switch {
                            position: relative;
                            display: inline-block;
                            width: 40px;
                            height: 20px;
                        }

                        
                        .switch input {
                            opacity: 0;
                            width: 0;
                            height: 0;
                        }

                    
                        .slider {
                            cursor: pointer;
                            position: absolute;
                            inset: 0;
                            background-color: #eee;
                            transition: 0.25s ease-in-out;
                            border-radius: 10px;
                            box-shadow: 0 3px #757575;
                        }

                        .slider:before {
                            position: absolute;
                            content: "";
                            height: 17.5px;
                            width: 17.5px;
                            border-radius: 12.75px;
                            left: 2px;
                            bottom: 3.5px;
                            background-color: #ff4255;
                            transition: 0.25s ease-in-out;
                            box-shadow: 0 3px #757575;
                        }

                        .slider:hover::before {
                            box-shadow: 0 5px #757575;
                            bottom: 6.5px;
                        }

                        input:checked+.slider:before {
                            transform: translateX(19px);
                            background: #34eb3d;
                        }
                        input:checked+.slider{
                             background-color: #c9c9c9;
                        }

        #toggle {
            top:20px;
            width:100px;
            left:10px;
        }

        .toggletitle {
            top:-35px;
            font-size:15px;
            color:white;
            font-family: "Pixelify Sans";
        }

        #colorPicker {
            visibility:hidden;
            pointer-events: none;
        }

        .addpicker{
            width:10%;
            left:37%;
            top:-10px;
        }

        .addcol{
            position:absolute;
            background:transparent;
            border:none;
            cursor:pointer;
            width:100%;
            left:50%;
            font-size:50px;
            font-family: "Pixelify Sans";
            color:white;
            font-weight:bold;
            top:0px;

            text-shadow:0 4px #595959;
            transition: all 0.4s;
        }

        .addcol:hover{
            text-shadow:0 5.5px #595959;
            top:-3.5px;
        }
        

        #colname {
            font-size:28px;
            background:transparent;
            border:none;
            cursor:text;
            position:absolute;
            width:27%;
            height:3vw;
            left:63%;
            outline:none;
            color:white;
            font-family: "Pixelify Sans";

        }

        ::placeholder{
            color:#d6d6d6;
        }

        .colstitle{
             color:white;
            font-family: "Pixelify Sans";
            font-size:32px;
            top:12%;
        }

        .scaleinp{
            width:100px;
            left:35%;
        }

        .scaleinp *{
            text-align: center;
            border:none;
            border-radius: 5px;
            height:20px;
            outline:none;
            font-weight: bold;
            font-family: "Comic Sans MS", "Comic Sans", cursive;
        }

        #desiredHeight{
            width:70%;
            right:0;
            background-color:#e6e6e6;
            color:#8f63ff;

        }

        #desiredHeight::placeholder{
            color:#8f63ff;
        }
        #desiredWidth::placeholder{
            color:#8f63ff;
        }

        #desiredWidth{
            width:20%;
            left:0;
            background-color:#8f63ff;
            color:#e6e6e6;
            border-radius:25px;
        }
        
        .grow{
            animation: gro .8s cubic-bezier(.88,0,0,1) forwards;
        }
        .shrink{
            animation: shrin .8s cubic-bezier(.88,0,0,1) forwards;

        }


        @keyframes gro{
            0%{width:20%;
                background-color:#8f63ff;
                color:#e6e6e6;
                border-radius:25px;
            }
            100%{width:70%;
                background-color:#e6e6e6;
                color:#8f63ff;
                border-radius:5px;
            }
        }
        @keyframes shrin{
            0%{width:70%;
                background-color:#e6e6e6;
            color:#8f63ff;
            border-radius:5px;}
            100%{width:20%;
            background-color:#8f63ff;
        color:#e6e6e6;
    border-radius:25px;}
        }



        @keyframes spinanim{
            0%{transform: rotate(0);}
            100%{transform: rotate(180deg);}
        }

        @keyframes unspinanim{
            0%{transform: rotate(180deg);}
            100%{transform: rotate(360deg);}
        }

        .spin{
            animation: spinanim .8s cubic-bezier(.88,0,0,1) forwards;
        }

        .unspin{
            animation: unspinanim .8s cubic-bezier(.88,0,0,1) forwards;
        }

        #colsmenu {
            background:transparent;
            font-family: "Pixelify Sans";
            font-size:32px;
            font-weight: bold;
            color:#8f63ff;
            border:none;
            top:-10px;
            cursor:pointer;
            left:10%;

            transition: all 0.4s;
        }

        #colsmenu:hover{
            top:-13.5px;
        }

        #compressButton{
            background:transparent;
            font-family: "Pixelify Sans";
            font-size:42px;
            font-weight: bolder;
            color:#8f63ff;
            border:none;
            cursor:pointer;
            top:41vw;
            left:55%;

            transition: all 0.4s;
        }

        #compressButton:hover{
           top:40vw;
        }


        input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Firefox */
input[type=number] {
  -moz-appearance: textfield;
}
        

    </style>

</head>
<body> 

    <div id="darken" style="display:none;" onclick="closemodal()"></div>
    <div id="menu">
        <img src="title.png" class="title">

        <input style="display:none" type="file" id="imageInput" accept="image/*">

        <img src="upload.png" alt="Upload" onclick="document.getElementById('imageInput').click();" class="upload-image">

        <img src="cloud.png" class="cloud">
    </div>

    <div id="modal" style="display:none;">
        <img src="modal.png" class="modalbkg">
        <div class="holder">
            <div id="canvases">
                <canvas id="originalCanvas" class="canvas"></canvas>
                <canvas  id="compressedCanvas" class="canvas"></canvas>
            </div>
            <div id="colsdiv">
                <h1 class="colstitle">Palette</h1>
                <div class="addpicker">
                    <button class="addcol" onclick="rpicker()">+</button>
                    <input style="" type="color" id="colorPicker">
                </div>
                <input type="text" id="colname" maxlength="28"  placeholder="name...">
                
                <div id="toggle">
                <p class="toggletitle">Use palette?</p>
                <label class="switch">
                  <input type="checkbox" id="togal" onclick="togglecols()">
                  <span class="slider"></span>
                </label>
                </div>

                <div id="colorList"></div>
            </div>      

            </div>
        <div  class="scaleinp">
            <input type="text"  onclick="htw()" oninput="this.value = this.value.replace(/[^\d.-]+/g, '');" id="desiredWidth" placeholder="Width" min="1" oninput="clearHeight()">
            <input type="text" id="desiredHeight" oninput="this.value = this.value.replace(/[^\d.-]+/g, '');" placeholder="Height" min="1" oninput="clearWidth()">
        </div>
        <div class="color">
            <button id="colsmenu" onclick="opencolormenu()">></button>
        </div>
        <button id="compressButton">Go!</button>

    </div>



    <div id="colprofile" style="display:none;">
        <textarea maxlength="28" id="rename" type="text" placeholder="PLACEHOLDER"></textarea>

        <img src="delete.png" id="del" onclick="delete()">
        <input id="edit" class="palette" type="color">
    </div> 
    <script>

        let colors = JSON.parse(localStorage.getItem('saves'));
        if (null==colors){
            colors=[];
        }
        let names = JSON.parse(localStorage.getItem('names'));
        if (null==names){
            names=[];
        }

        let img = new Image();
        let originalCanvas = document.getElementById('originalCanvas');
        let originalCtx = originalCanvas.getContext('2d');
        let compressedCtx;
        let compressedCanvas;
        let modal = document.getElementById("modal");
        let menu = document.getElementById("menu");
        let darken = document.getElementById("darken");

        let colsmenu = document.getElementById("colsdiv");
        let canvy = document.getElementById("canvases");
        let colbtn = document.getElementById("colsmenu");

        let profile = document.getElementById("colprofile");

        let picker = document.getElementById("colorPicker");

        const nametext = document.getElementById("colname");

        let usecols=false;
        let paltoggle = document.getElementById("togal");

        let wid = document.getElementById("desiredWidth");
        let hei = document.getElementById("desiredHeight");
        wid.value="W";



        let file;
        let reader;

        renderColorList();






        document.getElementById('imageInput').addEventListener('change', handleImageUpload);
        document.getElementById('compressButton').addEventListener('click', pixelateImage);
        document.getElementById('addColorButton').addEventListener('click', addColor);





        function wth(){
            wid.classList.remove("grow");
            wid.classList.add("shrink");
            wid.placeholder=wid.value;
            wid.value="";
            setTimeout(function(){
                wid.value="W";
                wid.placeholder="Width";
            }, 800);

            hei.classList.remove("shrink");
            hei.classList.add("grow");
            hei.value="";

            wid.onclick=function(){htw();};

        }
        function htw(){
            hei.classList.remove("grow");
            hei.classList.add("shrink");
            hei.placeholder=hei.value;
            hei.value="";
            setTimeout(function(){
                hei.value="H";
                hei.placeholder="Height";
            }, 800);

            wid.classList.remove("shrink");
            wid.classList.add("grow");
            wid.value="";

            hei.onclick=function(){wth();};
        }

        function togglecols(){
            usecols=paltoggle.checked;
            //usecols=!usecols
        }


        function save(){
            localStorage.setItem('saves',JSON.stringify(colors));
            localStorage.setItem('names', JSON.stringify(names));
        }

        function rpicker(){
            picker.click();
            addColor();
            picker.onchange=function(){colors[colors.length-1]=picker.value;
                console.log(colors)
                console.log(picker.value)
                renderColorList();
                save();
                nametext.value="";
            }

        }


        function handleImageUpload(event) {
            console.log("handlwe");
            file = event.target.files[0];
            reader = new FileReader();

            reader.onload = function(e) {
                img.onload = function() {
                    originalCanvas.width = img.width;
                    originalCanvas.height = img.height;
                    originalCtx.drawImage(img, 0, 0);
                };
                img.src = e.target.result;
            };

            reader.readAsDataURL(file);

            openModal();

            event.target.value="";
            
        }




        function opencolormenu(){
            console.log("opencols");
            colbtn.classList.remove("unspin");
            colbtn.classList.add("spin");
            setTimeout(function(){
                colbtn.onclick=function(){closecolormenu();}
            }, 500);

            colsmenu.classList.remove("rightc");
            canvy.classList.remove("rightc");
            colsmenu.classList.add("leftc");
            canvy.classList.add("leftc");
        }


        function closecolormenu(){
            colbtn.classList.remove("spin");
            colbtn.classList.add("unspin");
            setTimeout(function(){
                colbtn.onclick=function(){opencolormenu();}
            }, 500);
            colsmenu.classList.remove("leftc");
            canvy.classList.remove("leftc");
            colsmenu.classList.add("rightc");
            canvy.classList.add("rightc");
        }

        function openModal(){
            console.log("open");
            menu.classList.remove("inspec");
            menu.classList.add("outspec");
            setTimeout(function(){
                menu.style.display="none";
            }, 250);

            modal.classList.remove("outspec");
            modal.classList.add("inspec");

            modal.style.display="block";
            darken.style.display="block";

            darken.classList.remove("light");
            darken.classList.add("dark");
        }

        function closemodal(){

            closecolorprofile();
            closecolormenu();

            console.log("close");
            menu.style.display="block";
            menu.classList.remove("outspec");
            menu.classList.add("inspec");

            modal.classList.remove("inspec");
            modal.classList.add("outspec");

            darken.classList.remove("dark");
            darken.classList.add("light");
            setTimeout(function(){
                modal.style.display="none";
                darken.style.display="none";
            }, 250);

            compressedCtx.clearRect(0, 0, compressedCanvas.width, compressedCanvas.height);
            originalCtx.clearRect(0, 0, originalCanvas.width, originalCanvas.height);
            compressedCanvas.style.display="none";
        }

        function clearWidth() {
            document.getElementById('desiredWidth').value = '';
        }

        function clearHeight() {
            document.getElementById('desiredHeight').value = '';
        }

        function addColor() {
            const colorPicker = document.getElementById('colorPicker');
            let color = colorPicker.value;
            colors.push(color);

            let name = nametext.value;
            names.push(name);
            

            renderColorList();
            save();
        }

        function removeColor(index) {
            colors.splice(index, 1);
            names.splice(index, 1);

            renderColorList();
            save();
        }

        function renderColorList() {
            const colorList = document.getElementById('colorList');
            colorList.innerHTML = '';
            colors.forEach((color, index) => {
                let listItem = document.createElement('button');
                listItem.classList.add('colorSquare');
                listItem.style.backgroundColor = color;
                listItem.onclick = () => opencol(index);
                colorList.appendChild(listItem);
            });
        }

        function opencol(index){

            let rename = document.getElementById("rename");
            //let palette = document.getElementById("palette");
            let del = document.getElementById("del");
            let edit = document.getElementById("edit");

            rename.value=names[index];

            rename.onchange=function(){names[index]=rename.value};
            edit.value=colors[index];
            //edit.style.backgroundColor=colors[index];
            del.onclick=function(){removeColor(index);closecolorprofile();};
            edit.onchange=function(){colors[index]=edit.value;};






            opencolorprofile();


            //onchange="rename()"
            //delete
            //edit col
        }


        function opencolorprofile(){
            profile.style.display="block";
            colsmenu.classList.remove("leftc");
            colsmenu.classList.remove("inspec");
            colsmenu.classList.add("outspec");

            colbtn.onclick=function(){closecolorprofile();}

            profile.classList.remove("outspec");
            profile.classList.add("inspec");

        }

        function closecolorprofile(){
            colbtn.onclick=function(){closecolormenu();}
            setTimeout(function(){
                profile.style.display="none";
            }, 250);
            profile.classList.remove("inspec");
            profile.classList.add("outspec");


            colsmenu.classList.remove("outspec");
            colsmenu.classList.add("leftc");
            save();
            renderColorList();
        }

        function pixelateImage() {

            closecolormenu();
            closecolorprofile();


            const desiredWidth = parseInt(document.getElementById('desiredWidth').value);
            const desiredHeight = parseInt(document.getElementById('desiredHeight').value);

            if (isNaN(desiredWidth) && isNaN(desiredHeight)) {
                alert("Please enter a valid desired width or height greater than 0.");
                return;
            }

            let scaleFactor;
            if (!isNaN(desiredWidth)) {
                scaleFactor = img.width / desiredWidth;
            } else if (!isNaN(desiredHeight)) {
                scaleFactor = img.height / desiredHeight;
            }

            const newWidth = Math.floor(img.width / scaleFactor);
            const newHeight = Math.floor(img.height / scaleFactor);

            const imageData = originalCtx.getImageData(0, 0, img.width, img.height);
            const pixels = imageData.data;

            compressedCanvas = document.getElementById('compressedCanvas');
            compressedCtx = compressedCanvas.getContext('2d');
            compressedCanvas.width = img.width;
            compressedCanvas.height = img.height;

            for (let y = 0; y < newHeight; y++) {
                for (let x = 0; x < newWidth; x++) {
                    let r = 0, g = 0, b = 0, a = 0;
                    let count = 0;

                    for (let ky = 0; ky < scaleFactor; ky++) {
                        for (let kx = 0; kx < scaleFactor; kx++) {
                            const originalX = Math.floor(x * scaleFactor + kx);
                            const originalY = Math.floor(y * scaleFactor + ky);
                            if (originalX < img.width && originalY < img.height) {
                                const index = (originalY * img.width + originalX) * 4;
                                r += pixels[index];
                                g += pixels[index + 1];
                                b += pixels[index + 2];
                                a += pixels[index + 3];
                                count++;
                            }
                        }
                    }

                    r = r / count;
                    g = g / count;
                    b = b / count;
                    a = a / count;

                    // Find the closest color
                    if (colors.length==0 | usecols==false){
                        compressedCtx.fillStyle = `rgba(${r},${g},${b},${a / 255})`;
                        compressedCtx.fillRect(x * scaleFactor, y * scaleFactor, Math.ceil(scaleFactor), Math.ceil(scaleFactor));
                    } else {
                        const closestColor = findClosestColor(r, g, b);
                        // Draw the closest color
                        compressedCtx.fillStyle = closestColor;
                        compressedCtx.fillRect(x * scaleFactor, y * scaleFactor, Math.ceil(scaleFactor), Math.ceil(scaleFactor));
                    }
                }
            }

        compressedCanvas.style.display="initial";
        instructionsInit();

        }

        function instructionsInit(){
            compressedCanvas;
            //darken and turn pointer then show onclick n stuff
        }

        function stopInstructions(){
            
        }

        function findClosestColor(r, g, b) {
            let minDistance = Infinity;
            let closestColor = '#FFFFFF'; // Default to white if no colors are selected

            colors.forEach(color => {
                const colorRgb = hexToRgb(color);
                const distance = Math.sqrt(Math.pow(r - colorRgb.r, 2) + Math.pow(g - colorRgb.g, 2) + Math.pow(b - colorRgb.b, 2));
                if (distance < minDistance) {
                    minDistance = distance;
                    closestColor = color;
                }
            });

            return closestColor;
        }

        function hexToRgb(hex) {
            // Remove leading # and convert to base 16
            hex = hex.replace(/^#/, '');
            const bigint = parseInt(hex, 16);

            // Extract RGB components
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;

            return { r, g, b };
        }
    </script>
</body>
</html>